name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Top-level minimum permissions (Security best practice)
permissions:
  contents: read

jobs:
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install cargo-make
      run: |
        cargo install --locked cargo-make

    - name: Install dependencies
      run: |
        uv pip install --system -e ".[dev]"

    - name: Run Python quality checks
      run: bash scripts/ci-lint-python.sh

    - name: Check for common issues
      run: |
        # Check for print statements in source code (not tests)
        ! grep -r "print(" python/gradflow --include="*.py" || (echo "Found print() statements in source code" && exit 1)

        # Check for TODO/FIXME comments
        grep -r "TODO\|FIXME" python/gradflow --include="*.py" || echo "No TODO/FIXME found"


  clang-format:
    name: Clang-Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-15

    - name: Run clang-format
      run: |
        # Find C++ files and apply clang-format (skip if no files found)
        FILES=$(find include src tests -name '*.cpp' -o -name '*.hpp' -o -name '*.h' 2>/dev/null || true)
        if [ -n "$FILES" ]; then
          echo "$FILES" | xargs clang-format-15 -style=file -i -fallback-style=none
        else
          echo "No C++ source files found, skipping clang-format check"
        fi

    - name: Check for formatting changes
      run: |
        if git diff --exit-code; then
          echo "Code is properly formatted."
        else
          echo "Code formatting issues detected. Please run clang-format."
          git diff
          exit 1
        fi

  clang-tidy:
    name: Clang-Tidy Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          clang-15 \
          clang-tidy-15
        pip install conan==2.0.17

    - name: Configure Conan
      run: |
        conan profile detect --force

    - name: Cache Conan packages
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: ~/.conan2
        key: conan-${{ runner.os }}-clang-tidy-${{ hashFiles('conanfile.py') }}
        restore-keys: |
          conan-${{ runner.os }}-clang-tidy-
          conan-${{ runner.os }}-

    - name: Install dependencies with Conan
      run: |
        conan install . \
          --output-folder=build \
          --build=missing \
          --settings=build_type=Debug

    - name: Configure CMake
      env:
        CC: clang-15
        CXX: clang++-15
      run: |
        # Use CMake preset generated by Conan (conan-debug)
        cmake --preset conan-debug \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DGRADFLOW_BUILD_TESTS=OFF \
          -DGRADFLOW_BUILD_PYTHON=OFF

    - name: Run clang-tidy
      run: |
        # tests/ と include/ ディレクトリの C++ ファイルをチェック
        FILES=$(find tests include -name '*.cpp' -o -name '*.hpp' 2>/dev/null || true)
        if [ -n "$FILES" ]; then
          # Find the compile_commands.json in the build directory
          COMPILE_COMMANDS=$(find build -name compile_commands.json | head -n 1)
          if [ -z "$COMPILE_COMMANDS" ]; then
            echo "compile_commands.json not found, skipping clang-tidy"
            exit 0
          fi
          echo "Using compilation database: $COMPILE_COMMANDS"
          echo "$FILES" | xargs clang-tidy-15 \
            -p "$(dirname $COMPILE_COMMANDS)" \
            --config-file=.clang-tidy \
            --warnings-as-errors='*'
        else
          echo "No C++ source files found, skipping clang-tidy check"
        fi

    - name: Upload clang-tidy results
      if: failure()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: clang-tidy-report
        path: build/clang-tidy-report.txt
        retention-days: 30

  cppcheck:
    name: Cppcheck Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        # Check if src directory exists and has C++ files
        if [ -d "src" ] && find src -name '*.cpp' -o -name '*.hpp' | grep -q .; then
          cppcheck \
            --enable=all \
            --error-exitcode=1 \
            --inline-suppr \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --std=c++17 \
            --language=c++ \
            --force \
            --xml \
            --xml-version=2 \
            --output-file=cppcheck-report.xml \
            -I include \
            src
        else
          echo "No C++ source files found in src directory, skipping cppcheck"
          # Create empty report for consistency
          echo '<?xml version="1.0" encoding="UTF-8"?><results version="2"></results>' > cppcheck-report.xml
        fi

    - name: Generate HTML report
      if: always()
      run: |
        sudo apt-get install -y cppcheck-htmlreport
        cppcheck-htmlreport \
          --file=cppcheck-report.xml \
          --report-dir=cppcheck-html \
          --source-dir=.

    - name: Upload cppcheck results
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: cppcheck-report
        path: |
          cppcheck-report.xml
          cppcheck-html/
        retention-days: 30

  include-what-you-use:
    name: Include-What-You-Use Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          clang-15 \
          iwyu
        pip install conan==2.0.17

    - name: Configure Conan
      run: |
        conan profile detect --force
        conan install . \
          --output-folder=build \
          --build=missing \
          --settings=build_type=Debug

    - name: Configure CMake
      env:
        CC: clang-15
        CXX: clang++-15
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DCMAKE_CXX_INCLUDE_WHAT_YOU_USE="iwyu;-Xiwyu;--error_always" \
          -DGRADFLOW_BUILD_TESTS=OFF

    - name: Build with IWYU
      continue-on-error: true
      run: |
        # Check if there are C++ source files to build
        if [ -d "src" ] && find src -name '*.cpp' | grep -q .; then
          cmake --build build 2>&1 | tee iwyu-report.txt
        else
          echo "No C++ source files found, skipping IWYU check" | tee iwyu-report.txt
        fi

    - name: Check IWYU suggestions
      run: |
        if grep -q "should add these lines:" iwyu-report.txt; then
          echo "Include-What-You-Use found issues. Please review."
          cat iwyu-report.txt
          exit 1
        elif grep -q "No C++ source files found" iwyu-report.txt; then
          echo "Skipped IWYU check (no source files)"
        else
          echo "Include-What-You-Use check passed."
        fi

    - name: Upload IWYU report
      if: always()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: iwyu-report
        path: iwyu-report.txt
        retention-days: 30

  cmake-format:
    name: CMake Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install cmake-format
      run: |
        pip install cmakelang

    - name: Run cmake-format
      run: |
        find . -name 'CMakeLists.txt' -o -name '*.cmake' | \
          xargs cmake-format -i

    - name: Check for formatting changes
      run: |
        if git diff --exit-code; then
          echo "CMake files are properly formatted."
        else
          echo "CMake formatting issues detected. Please run cmake-format."
          git diff
          exit 1
        fi

  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install lizard
      run: |
        pip install lizard

    - name: Run complexity analysis
      run: |
        # Check if there are C++ source directories
        if [ -d "src" ] || [ -d "include" ]; then
          lizard \
            -l cpp \
            -w \
            -C 15 \
            -L 1000 \
            src include \
            > complexity-report.txt || true
        else
          echo "No C++ source directories found, skipping complexity analysis" > complexity-report.txt
        fi

    - name: Check complexity thresholds
      run: |
        if grep -q "warning:" complexity-report.txt; then
          echo "High complexity functions found. Consider refactoring."
          cat complexity-report.txt
          # 警告のみで失敗させない
        elif grep -q "No C++ source directories found" complexity-report.txt; then
          echo "Skipped complexity analysis (no source directories)"
        else
          echo "Complexity check passed."
        fi

    - name: Upload complexity report
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: complexity-report
        path: complexity-report.txt
        retention-days: 30

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@ea9e4e37992a54ee68a9622e985e60c8e8f12b9f # v3
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Upload Trivy results as artifact
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: trivy-security-report
        path: trivy-results.sarif
        retention-days: 30
