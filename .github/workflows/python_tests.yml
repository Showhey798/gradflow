name: Python Bindings Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'python/**'
      - 'include/**'
      - 'src/**'
      - '.github/workflows/python_tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'python/**'
      - 'include/**'
      - 'src/**'
      - '.github/workflows/python_tests.yml'

env:
  CONAN_VERSION: 2.0.17

jobs:
  python-bindings:
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake ninja

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install cmake ninja -y

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install conan==${{ env.CONAN_VERSION }}
        uv pip install -e ".[dev]"

    - name: Configure Conan
      run: |
        conan profile detect --force
        conan install . \
          --output-folder=build \
          --build=missing \
          --settings=build_type=Release

    - name: Build Python bindings (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake \
          -DGRADFLOW_BUILD_PYTHON_BINDINGS=ON \
          -DGRADFLOW_BUILD_TESTS=OFF \
          -DPython_EXECUTABLE=$(which python)
        cmake --build build --config Release --parallel

    - name: Build Python bindings (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cmake -B build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_TOOLCHAIN_FILE=build/conan_toolchain.cmake `
          -DGRADFLOW_BUILD_PYTHON_BINDINGS=ON `
          -DGRADFLOW_BUILD_TESTS=OFF `
          -DPython_EXECUTABLE=$(python -c "import sys; print(sys.executable)")
        cmake --build build --config Release --parallel

    - name: Install Python package
      run: |
        pip install -e .

    - name: Run Python tests
      run: |
        pytest python/tests \
          -v \
          --cov=gradflow \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term

    - name: Run Python type checking
      run: |
        pyright python

    - name: Run Python linting and formatting
      run: |
        ruff format --check python
        ruff check python

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage.xml
        flags: python
        name: codecov-python-${{ matrix.python-version }}
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          htmlcov/
          coverage.xml
        retention-days: 7

  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: python-bindings

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install cibuildwheel
      run: |
        python -m pip install --upgrade pip
        pip install cibuildwheel==2.16.2

    - name: Build wheels
      env:
        CIBW_BUILD: cp39-* cp310-* cp311-* cp312-*
        CIBW_SKIP: "*-musllinux_*"
        CIBW_ARCHS_MACOS: x86_64 arm64
        CIBW_ARCHS_LINUX: x86_64
        CIBW_ARCHS_WINDOWS: AMD64
        CIBW_BEFORE_ALL_LINUX: yum install -y cmake ninja-build || apt-get install -y cmake ninja-build
        CIBW_BEFORE_ALL_MACOS: brew install cmake ninja
        CIBW_BEFORE_BUILD: pip install conan==2.0.17 && conan profile detect --force
        CIBW_TEST_COMMAND: pytest {project}/python/tests -v
        CIBW_TEST_REQUIRES: pytest numpy
      run: |
        python -m cibuildwheel --output-dir wheelhouse

    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: ./wheelhouse/*.whl
        retention-days: 7

  test-import:
    name: Test package import
    runs-on: ${{ matrix.os }}
    needs: build-wheels

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Download wheels
      uses: actions/download-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: wheelhouse/

    - name: Install wheel (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        pip install wheelhouse/gradflow-*-cp${{ matrix.python-version | replace('.', '') }}-*.whl

    - name: Install wheel (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $wheel = Get-ChildItem wheelhouse/gradflow-*-cp${{ matrix.python-version | replace('.', '') }}-*.whl
        pip install $wheel

    - name: Test import
      run: |
        python -c "import gradflow; print(f'GradFlow version: {gradflow.__version__}')"
        python -c "import gradflow; print(f'Available backends: {gradflow.available_backends()}')"

  publish-test-pypi:
    name: Publish to Test PyPI
    runs-on: ubuntu-latest
    needs: [python-bindings, build-wheels]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Download all wheels
      uses: actions/download-artifact@v4
      with:
        pattern: wheels-*
        path: dist/
        merge-multiple: true

    - name: Publish to Test PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true

  python-documentation:
    name: Build Python Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        uv pip install -e ".[dev]"
        pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints

    - name: Build documentation
      run: |
        cd docs
        make html

    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: python-docs
        path: docs/_build/html
        retention-days: 30

    - name: Deploy to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_build/html
