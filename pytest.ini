[pytest]
# GradFlow pytest 設定

# テストディレクトリ
testpaths = python/tests

# Python パスの設定
pythonpath = python

# テストファイルのパターン
python_files = test_*.py *_test.py

# テストクラスのパターン
python_classes = Test*

# テスト関数のパターン
python_functions = test_*

# 最小 Python バージョン
minversion = 7.0

# 追加オプション（デフォルト）
addopts =
    # 詳細な出力
    -v
    # テスト中の警告を表示
    -W default
    # doctest を有効化
    --doctest-modules
    # 失敗したテストを最初に実行
    --failed-first
    # ローカル変数を表示
    --showlocals
    # カバレッジ設定
    --cov=gradflow
    --cov-report=term-missing
    --cov-report=html
    --cov-report=xml
    # カバレッジの最小閾値（80%）
    --cov-fail-under=80
    # 並列実行（CPU コア数に応じて自動）
    -n auto
    # テストのタイムアウト（デフォルト: 300秒）
    --timeout=300
    # strict markers（未定義のマーカーを検出）
    --strict-markers
    # strict config（設定エラーを検出）
    --strict-config

# カスタムマーカーの定義
markers =
    slow: 実行時間が長いテスト（--runslow で実行）
    integration: 統合テスト
    unit: 単体テスト
    gpu: GPU が必要なテスト
    metal: Metal GPU が必要なテスト（macOS）
    cuda: CUDA GPU が必要なテスト（NVIDIA）
    benchmark: ベンチマークテスト
    property: プロパティベーステスト（hypothesis）
    smoke: スモークテスト（基本的な動作確認）
    numerical: 数値勾配チェックを含むテスト

# 警告フィルター
filterwarnings =
    # デフォルトで全ての警告を表示
    default
    # DeprecationWarning を無視しない
    default::DeprecationWarning
    # 特定のライブラリの警告を無視（必要に応じて追加）
    # ignore::DeprecationWarning:numpy.*

# テストディスカバリーから除外
norecursedirs =
    .git
    .tox
    dist
    build
    *.egg
    __pycache__
    .cache
    .pytest_cache
    htmlcov
    .hypothesis

# Doctest の設定
doctest_optionflags =
    NORMALIZE_WHITESPACE
    ELLIPSIS
    IGNORE_EXCEPTION_DETAIL

# ログ設定
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Console 出力設定
console_output_style = progress

# xfail strict mode（xfail が成功した場合に失敗扱い）
xfail_strict = false

# ML 固有の設定
# テストの再現性を確保するため、ランダムシードを固定
# （各テスト内で明示的にシード設定することを推奨）
