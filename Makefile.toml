# GradFlow Makefile for cargo-make
# ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦ cargo-make ã‚’ä½¿ç”¨
#
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: cargo install cargo-make
# ä½¿ç”¨æ–¹æ³•: makers <task>
# ã‚¿ã‚¹ã‚¯ä¸€è¦§: makers --list-all-steps

[config]
default_to_workspace = false
skip_core_tasks = true
skip_git_env_info = true
skip_rust_env_info = true
skip_crate_env_info = true

[env]
PROJECT_ROOT = "${CARGO_MAKE_WORKING_DIRECTORY}"
PYTHON_SRC = "${PROJECT_ROOT}/python"
CPP_SRC = "${PROJECT_ROOT}/src"
BUILD_DIR = "${PROJECT_ROOT}/build"
PYTHONPATH = "${PYTHON_SRC}"

# ========================================
# Python é–‹ç™ºç’°å¢ƒ
# ========================================

[tasks.install]
description = "uv ã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ“¦ Installing dependencies with uv..."
if ! command -v uv &> /dev/null; then
    echo "âŒ uv is not installed. Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
fi
uv pip install --system -e ".[dev]"
echo "âœ… Dependencies installed"
'''

[tasks.install-uv]
description = "uv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
script = '''
#!/usr/bin/env bash
if ! command -v uv &> /dev/null; then
    echo "ğŸ“¦ Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    echo "âœ… uv installed"
else
    echo "âœ… uv is already installed"
fi
'''

# ========================================
# Python ã‚³ãƒ¼ãƒ‰å“è³ª
# ========================================

[tasks.format]
description = "ruff format ã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ¨ Formatting Python code with ruff..."
ruff format ${PYTHON_SRC}
echo "âœ… Formatting complete"
'''

[tasks.format-check]
description = "ruff format ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´ãªã—ï¼‰"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ” Checking Python code formatting..."
ruff format --check ${PYTHON_SRC}
echo "âœ… Format check complete"
'''

[tasks.lint]
description = "ruff check ã§ãƒªãƒ³ãƒˆ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ” Linting Python code with ruff..."
ruff check ${PYTHON_SRC}
echo "âœ… Lint check complete"
'''

[tasks.lint-fix]
description = "ruff check ã§ãƒªãƒ³ãƒˆã—ã¦è‡ªå‹•ä¿®æ­£"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ”§ Linting and fixing Python code with ruff..."
ruff check --fix ${PYTHON_SRC}
echo "âœ… Lint and fix complete"
'''

[tasks.typecheck]
description = "pyright ã§å‹ãƒã‚§ãƒƒã‚¯"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ” Type checking with pyright..."
pyright ${PYTHON_SRC}
echo "âœ… Type check complete"
'''

[tasks.check]
description = "format-check + lint + typecheck ã‚’å®Ÿè¡Œ"
dependencies = ["format-check", "lint", "typecheck"]

# ========================================
# Python ãƒ†ã‚¹ãƒˆ
# ========================================

[tasks.test]
description = "pytest ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ§ª Running Python tests with pytest..."
pytest ${PYTHON_SRC}/tests -v
echo "âœ… Tests complete"
'''

[tasks.test-fast]
description = "ä¸¦åˆ—å®Ÿè¡Œãªã—ã§é«˜é€Ÿãƒ†ã‚¹ãƒˆ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ§ª Running Python tests (fast mode)..."
pytest ${PYTHON_SRC}/tests -v -n 0
echo "âœ… Fast tests complete"
'''

[tasks.test-unit]
description = "å˜ä½“ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ§ª Running unit tests..."
pytest ${PYTHON_SRC}/tests -v -m unit
echo "âœ… Unit tests complete"
'''

[tasks.test-integration]
description = "çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ§ª Running integration tests..."
pytest ${PYTHON_SRC}/tests -v -m integration
echo "âœ… Integration tests complete"
'''

[tasks.test-gpu]
description = "GPU ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ§ª Running GPU tests..."
pytest ${PYTHON_SRC}/tests -v -m "metal or cuda"
echo "âœ… GPU tests complete"
'''

[tasks.coverage]
description = "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ“Š Generating coverage report..."
pytest ${PYTHON_SRC}/tests --cov=gradflow --cov-report=term-missing --cov-report=html
echo "âœ… Coverage report generated in htmlcov/"
'''

# ========================================
# C++ ãƒ“ãƒ«ãƒ‰
# ========================================

[tasks.build]
description = "CMake ã§ C++ ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ”¨ Building C++ code with CMake..."
mkdir -p ${BUILD_DIR}
cd ${BUILD_DIR}
cmake .. -DGRADFLOW_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release
cmake --build . --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
echo "âœ… Build complete"
'''

[tasks.build-debug]
description = "ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ãƒ“ãƒ«ãƒ‰"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ”¨ Building C++ code (Debug mode)..."
mkdir -p ${BUILD_DIR}
cd ${BUILD_DIR}
cmake .. -DGRADFLOW_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Debug
cmake --build . --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
echo "âœ… Debug build complete"
'''

[tasks.build-release]
description = "ãƒªãƒªãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§ãƒ“ãƒ«ãƒ‰"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ”¨ Building C++ code (Release mode)..."
mkdir -p ${BUILD_DIR}
cd ${BUILD_DIR}
cmake .. -DGRADFLOW_BUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-O3 -march=native"
cmake --build . --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
echo "âœ… Release build complete"
'''

[tasks.test-cpp]
description = "CTest ã§ C++ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
dependencies = ["build"]
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ§ª Running C++ tests with CTest..."
cd ${BUILD_DIR}
ctest --output-on-failure --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 4)
echo "âœ… C++ tests complete"
'''

[tasks.clean-build]
description = "ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³"
script = '''
#!/usr/bin/env bash
echo "ğŸ§¹ Cleaning build directory..."
rm -rf ${BUILD_DIR}
echo "âœ… Build directory cleaned"
'''

# ========================================
# C++ ã‚³ãƒ¼ãƒ‰å“è³ª
# ========================================

[tasks.format-cpp]
description = "clang-format ã§ C++ ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ¨ Formatting C++ code with clang-format..."
find ${CPP_SRC} -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | xargs clang-format -i
echo "âœ… C++ formatting complete"
'''

[tasks.format-cpp-check]
description = "clang-format ã§ C++ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ” Checking C++ code formatting..."
find ${CPP_SRC} -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | xargs clang-format --dry-run -Werror
echo "âœ… C++ format check complete"
'''

[tasks.lint-cpp]
description = "clang-tidy ã§ C++ ã‚’ãƒªãƒ³ãƒˆ"
dependencies = ["build"]
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ” Linting C++ code with clang-tidy..."
cd ${BUILD_DIR}
run-clang-tidy -p . -header-filter='.*' ${CPP_SRC}
echo "âœ… C++ lint complete"
'''

# ========================================
# è¤‡åˆã‚¿ã‚¹ã‚¯
# ========================================

[tasks.test-all]
description = "Python ã¨ C++ ã®å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
dependencies = ["test", "test-cpp"]

[tasks.ci]
description = "CI ã§å®Ÿè¡Œã™ã‚‹å…¨ãƒã‚§ãƒƒã‚¯ï¼ˆPython + C++ï¼‰"
dependencies = ["format-check", "lint", "typecheck", "format-cpp-check", "build", "test-all"]

[tasks.dev]
description = "é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
dependencies = ["install-uv", "install"]
script = '''
#!/usr/bin/env bash
echo "ğŸ”§ Setting up development environment..."
echo "Installing pre-commit hooks..."
pre-commit install
echo "âœ… Development environment ready"
'''

[tasks.qa]
description = "ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆPython + C++ format + lint + typecheckï¼‰"
run_task = { name = ["format", "format-cpp", "lint-fix", "typecheck"] }

# ========================================
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
# ========================================

[tasks.docs]
description = "Sphinx ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ“š Building documentation with Sphinx..."
cd ${PROJECT_ROOT}/docs
make html
echo "âœ… Documentation built in docs/_build/html/"
'''

[tasks.docs-serve]
description = "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
dependencies = ["docs"]
script = '''
#!/usr/bin/env bash
echo "ğŸŒ Starting documentation server..."
cd ${PROJECT_ROOT}/docs/_build/html
python -m http.server 8000
'''

# ========================================
# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ========================================

[tasks.clean]
description = "ç”Ÿæˆç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³"
script = '''
#!/usr/bin/env bash
echo "ğŸ§¹ Cleaning generated files..."
rm -rf ${BUILD_DIR}
rm -rf ${PROJECT_ROOT}/htmlcov
rm -rf ${PROJECT_ROOT}/.pytest_cache
rm -rf ${PROJECT_ROOT}/.ruff_cache
rm -rf ${PROJECT_ROOT}/.mypy_cache
rm -rf ${PROJECT_ROOT}/.hypothesis
find ${PROJECT_ROOT} -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
find ${PROJECT_ROOT} -type f -name "*.pyc" -delete 2>/dev/null || true
find ${PROJECT_ROOT} -type f -name "*.pyo" -delete 2>/dev/null || true
find ${PROJECT_ROOT} -type f -name ".coverage" -delete 2>/dev/null || true
echo "âœ… Cleanup complete"
'''

[tasks.clean-all]
description = "å…¨ã¦ã‚’ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆä¾å­˜é–¢ä¿‚å«ã‚€ï¼‰"
dependencies = ["clean"]
script = '''
#!/usr/bin/env bash
echo "ğŸ§¹ Cleaning all files including dependencies..."
rm -rf ${PROJECT_ROOT}/.venv
rm -rf ${PROJECT_ROOT}/venv
rm -rf ${PROJECT_ROOT}/*.egg-info
rm -rf ${PROJECT_ROOT}/dist
echo "âœ… Full cleanup complete"
'''

# ========================================
# ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
# ========================================

[tasks.bench]
description = "ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œ"
script = '''
#!/usr/bin/env bash
set -e
echo "âš¡ Running benchmarks..."
pytest ${PYTHON_SRC}/tests -v -m benchmark --benchmark-only
echo "âœ… Benchmarks complete"
'''

# ========================================
# ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
# ========================================

[tasks.profile]
description = "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ"
script = '''
#!/usr/bin/env bash
set -e
echo "ğŸ“Š Profiling Python code..."
python -m cProfile -o profile.stats -m pytest ${PYTHON_SRC}/tests
echo "âœ… Profile saved to profile.stats"
echo "View with: python -m pstats profile.stats"
'''

# ========================================
# ãƒ˜ãƒ«ãƒ—
# ========================================

[tasks.default]
alias = "help"

[tasks.help]
description = "åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º"
script = '''
#!/usr/bin/env bash
echo "ğŸš€ GradFlow Task Runner (cargo-make)"
echo ""
echo "ğŸ“¦ Setup:"
echo "  dev              - é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
echo "  install          - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
echo "  install-uv       - uv ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
echo ""
echo "ğŸ¨ Formatting:"
echo "  format           - Python ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
echo "  format-check     - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯"
echo "  format-cpp       - C++ ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
echo ""
echo "ğŸ” Linting:"
echo "  lint             - Python ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ãƒˆ"
echo "  lint-fix         - ãƒªãƒ³ãƒˆã—ã¦è‡ªå‹•ä¿®æ­£"
echo "  lint-cpp         - C++ ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ³ãƒˆ"
echo "  typecheck        - å‹ãƒã‚§ãƒƒã‚¯"
echo "  check            - å…¨ãƒã‚§ãƒƒã‚¯ï¼ˆformat + lint + typecheckï¼‰"
echo ""
echo "ğŸ§ª Testing:"
echo "  test             - Python ãƒ†ã‚¹ãƒˆ"
echo "  test-fast        - é«˜é€Ÿãƒ†ã‚¹ãƒˆ"
echo "  test-unit        - å˜ä½“ãƒ†ã‚¹ãƒˆ"
echo "  test-integration - çµ±åˆãƒ†ã‚¹ãƒˆ"
echo "  test-gpu         - GPU ãƒ†ã‚¹ãƒˆ"
echo "  test-cpp         - C++ ãƒ†ã‚¹ãƒˆ"
echo "  test-all         - å…¨ãƒ†ã‚¹ãƒˆ"
echo "  coverage         - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ"
echo ""
echo "ğŸ”¨ Building:"
echo "  build            - C++ ãƒ“ãƒ«ãƒ‰ï¼ˆReleaseï¼‰"
echo "  build-debug      - ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰"
echo "  build-release    - ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰"
echo ""
echo "ğŸ“š Documentation:"
echo "  docs             - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ"
echo "  docs-serve       - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•"
echo ""
echo "ğŸ§¹ Cleanup:"
echo "  clean            - ç”Ÿæˆç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³"
echo "  clean-all        - å…¨ã¦ã‚’ã‚¯ãƒªãƒ¼ãƒ³"
echo "  clean-build      - ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚¯ãƒªãƒ¼ãƒ³"
echo ""
echo "âš¡ Performance:"
echo "  bench            - ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ"
echo "  profile          - ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°"
echo ""
echo "ğŸš€ CI/CD:"
echo "  ci               - CI ãƒã‚§ãƒƒã‚¯"
echo "  qa               - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯"
echo ""
echo "ä½¿ç”¨æ–¹æ³•: makers <task>"
echo "å…¨ã‚¿ã‚¹ã‚¯ä¸€è¦§: makers --list-all-steps"
'''
